<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ file.name }} - Details</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#f5f5f5;color:#333}
    .hero{position:relative;background:#000}
    .hero img{width:100%;height:auto;display:block}
    .nav{position:absolute;top:1rem;left:1rem;right:1rem;display:flex;justify-content:space-between}
    .nav a{color:#fff;text-decoration:none;background:rgba(0,0,0,.35);padding:.45rem .75rem;border-radius:8px}
    .title{position:absolute;left:1rem;bottom:1rem;color:#fff;font-size:1.75rem;text-shadow:0 2px 8px rgba(0,0,0,.5)}
    .container{max-width:1100px;margin:1.25rem auto;padding:0 1rem}
    .grid{display:grid;grid-template-columns: 1fr 1fr; gap:1rem}
    @media (max-width: 900px){ .grid{grid-template-columns: 1fr} }
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:1rem}
    .row{display:flex;justify-content:space-between;margin:.35rem 0}
    .label{color:#666;font-weight:600}
    .badge{display:inline-block;padding:.2rem .55rem;border-radius:999px;font-size:.8rem;color:#fff}
    .badge.ok{background:#2e7d32}.badge.pending{background:#757575}.badge.dup{background:#d32f2f}.badge.warn{background:#ef6c00}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#f3f4f6; padding:.2rem .35rem; border-radius:4px}
    .upload-panel { margin-top:.5rem; background:#f9fafc; border:1px solid #e6e8f2; border-radius:10px; padding:.75rem; }
    .upload-row { display:flex; flex-direction:column; gap:.35rem; margin:.35rem 0; }
    .upload-row input[type="text"] { padding:.5rem .6rem; border:2px solid #e5e7eb; border-radius:8px; font-size:.95rem; }
    .btn { border:none; padding:.55rem .9rem; border-radius:8px; font-weight:600; cursor:pointer; }
    .btn-primary { background:#4a56e2; color:#fff; }
    .btn-primary:disabled { background:#c5c9ff; cursor:not-allowed; }
    .hint { font-size:.85rem; color:#666; }
    .status { font-size:.9rem; }
    .status.ok { color:#2e7d32; }
    .status.err { color:#d32f2f; }
  </style>
</head>
<body>
  <div class="hero">
    <img src="{{ file.urls.image }}" alt="{{ file.name }}">
    <div class="nav">
      <a href="/">‚Üê Back</a>
      <a href="/settings">‚öô Settings</a>
    </div>
    <div class="title">{{ file.name }}</div>
  </div>

  <div class="container">
    <div class="grid">
      <div class="card">
        <h3>File Info</h3>
        <div class="row"><span class="label">Size</span><span>{{ "%.2f"|format(file.size_mb) }} MB</span></div>
        <div class="row"><span class="label">Created</span><span>{{ file.created }}</span></div>
        <div class="row"><span class="label">Modified</span><span>{{ file.modified }}</span></div>
        <div class="row"><span class="label">Path</span><span class="mono">{{ file.path }}</span></div>
      </div>

      <div class="card">
        <h3>Commons Check</h3>
        <div class="row">
          <span class="label">Status</span>
          <span>
            {% if file.commons_check_status == 'NOT_ON_COMMONS' %}
              <span class="badge ok">‚úì Safe to upload</span>
            {% elif file.commons_check_status == 'EXACT_MATCH' %}
              <span class="badge dup">Duplicate</span>
            {% elif file.commons_check_status == 'POSSIBLE_SCALED_VARIANT' %}
              <span class="badge warn">Variant?</span>
            {% elif file.commons_check_status == 'EXISTS_DIFFERENT_CONTENT' %}
              <span class="badge warn">Name conflict</span>
            {% elif file.commons_check_status == 'PENDING' %}
              <span class="badge pending">Pending</span>
            {% else %}
              <span class="badge pending">{{ file.commons_check_status }}</span>
            {% endif %}
          </span>
        </div>
        {% if file.sha1_local %}
        <div class="row"><span class="label">Local SHA-1</span><span class="mono">{{ file.sha1_local }}</span></div>
        {% endif %}

        {% if file.commons_matches and file.commons_matches|length %}
          <div style="margin-top:.5rem;">
            <div class="label" style="margin-bottom:.35rem;">Matches:</div>
            <ul style="padding-left:1rem;">
              {% for m in file.commons_matches %}
                <li><a href="{{ m.url }}" target="_blank">{{ m.title }}</a></li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>
    </div>

    {% if file.commons_check_status == "NOT_ON_COMMONS" %}
    <div class="card" style="margin-top:1rem;">
      <h3>Upload to Wikimedia Commons</h3>
      {% if not upload_enabled %}
        <p class="hint">üîí Upload disabled. Add <code>COMMONS_USERNAME</code> and <code>COMMONS_PASSWORD</code> to your <code>.env</code>, then restart.</p>
      {% endif %}

      <div class="upload-panel">
        <div class="upload-row">
          <label>Commons filename</label>
          <input id="target" type="text" value="{{ file.upload_suggestion.suggested_filename }}" {{ 'disabled' if not upload_enabled else '' }}>
        </div>
        <div class="upload-row">
          <label>Category</label>
          <input id="cat" type="text" value="{{ file.upload_suggestion.category_slug }}" {{ 'disabled' if not upload_enabled else '' }}>
        </div>
        <div class="upload-row" style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;">
          <button id="btn" class="btn btn-primary" onclick="uploadNow()" {{ 'disabled' if not upload_enabled else '' }}>‚¨ÜÔ∏è Upload</button>
          <span id="st" class="status"></span>
        </div>
        <p class="hint" style="margin-top:.35rem;">You can edit the filename before uploading.</p>
      </div>
    </div>
    {% endif %}
  </div>

  <script>
  async function uploadNow() {
    const btn = document.getElementById('btn');
    const st = document.getElementById('st');
    const target = document.getElementById('target').value.trim();
    const category_slug = document.getElementById('cat').value.trim();
    if (!target) { alert('Please enter a target filename.'); return; }

    btn.disabled = true;
    st.textContent = 'Uploading‚Ä¶';
    st.className = 'status';

    try {
      const resp = await fetch('{{ url_for("api_upload") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          filename: {{ file.path|tojson }},
          target: target,
          category_slug: category_slug
        })
      });
      const ct = resp.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await resp.json() : { ok:false, error: 'Non-JSON response', status: resp.status };

      if (!resp.ok || !data.ok) {
        st.textContent = 'Upload failed';
        st.className = 'status err';
        console.error('Upload error', data);
        alert('Upload failed: ' + (data.error ? JSON.stringify(data.error) : resp.statusText));
        btn.disabled = false;
        return;
      }
      st.textContent = 'Uploaded ‚úì';
      st.className = 'status ok';
      if (data.url) window.open(data.url, '_blank');
      setTimeout(() => location.reload(), 600);
    } catch (e) {
      st.textContent = 'Upload error';
      st.className = 'status err';
      console.error('Upload exception', e);
      alert('Upload error: ' + e);
      btn.disabled = false;
    }
  }
  </script>
</body>
</html>
