<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Folder-to-Commons-Uploader - File Monitor</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; background:#f5f5f5; color:#333; }
    .header { background:linear-gradient(135deg,#667eea 0%, #764ba2 100%); color:#fff; padding:2rem; position:relative; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
    .header h1 { font-size:2rem; margin-bottom:.25rem; }
    .header p { opacity:.9; }
    .settings-link { position:absolute; right:2rem; top:2rem; text-decoration:none; color:#fff; background:rgba(255,255,255,0.18); padding:.5rem 1rem; border-radius:8px; }
    .container { max-width:1200px; margin:2rem auto; padding:0 1rem; }
    .files-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:1.25rem; }
    .file-card { background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,.08); }
    .file-card__thumb { width:100%; height:200px; object-fit:cover; background:#eee; display:block; }
    .file-card__body { padding:1rem; }
    .file-name { font-weight:700; color:#4a56e2; margin-bottom:.35rem; word-break: break-word; }
    .muted { color:#666; font-size:.9rem; }
    .row { display:flex; justify-content:space-between; gap:1rem; margin:.25rem 0; }
    .badge { display:inline-block; padding:.2rem .5rem; border-radius:999px; font-size:.8rem; color:#fff; }
    .badge.ok { background:#2e7d32; }
    .badge.pending { background:#757575; }
    .badge.dup { background:#d32f2f; }
    .badge.warn { background:#ef6c00; }

    .upload-panel { margin-top:.75rem; background:#f9fafc; border:1px solid #e6e8f2; border-radius:10px; padding:.75rem; }
    .upload-panel h4 { font-size:1rem; margin-bottom:.5rem; color:#4a56e2; }
    .upload-row { display:flex; flex-direction:column; gap:.35rem; margin:.35rem 0; }
    .upload-row label { font-weight:600; font-size:.85rem; color:#444; }
    .upload-row input[type="text"] { padding:.5rem .6rem; border:2px solid #e5e7eb; border-radius:8px; font-size:.95rem; }
    .upload-actions { display:flex; gap:.5rem; align-items:center; margin-top:.35rem; flex-wrap:wrap; }
    .btn { border:none; padding:.55rem .9rem; border-radius:8px; font-weight:600; cursor:pointer; }
    .btn-primary { background:#4a56e2; color:#fff; }
    .btn-primary[disabled] { background:#c5c9ff; cursor:not-allowed; }
    .hint { font-size:.85rem; color:#666; }
    .status { font-size:.9rem; }
    .status.ok { color:#2e7d32; }
    .status.err { color:#d32f2f; }
    .divider { height:1px; background:#efefef; margin:.6rem 0; }
    .clickable { cursor:pointer; }
  </style>
</head>
<body>
  <div class="header">
    <a class="settings-link" href="/settings">‚öôÔ∏è Settings</a>
    <h1>Folder-to-Commons-Uploader</h1>
    <p>Watching your folder and checking Wikimedia Commons duplicates.</p>
  </div>

  <div class="container">
    {% if files and files|length %}
    <div class="files-grid">
      {% for file in files %}
      <div class="file-card">
        <div class="clickable" onclick="location.href='{{ file.urls.detail }}'">
          <img class="file-card__thumb" src="{{ file.urls.thumb }}" alt="{{ file.name }}"
               onerror="this.onerror=null;this.src='{{ file.urls.image }}'">
        </div>

        <div class="file-card__body">
          <div class="file-name clickable" onclick="location.href='{{ file.urls.detail }}'">{{ file.name }}</div>
          <div class="row"><span class="muted">Size</span><span>{{ "%.2f"|format(file.size_mb) }} MB</span></div>
          <div class="row"><span class="muted">Created</span><span>{{ file.created }}</span></div>

          {% if file.commons_check_status %}
            <div class="row" style="align-items:center;">
              <span class="muted">Commons</span>
              {% if file.commons_check_status == "NOT_ON_COMMONS" %}
                <span class="badge ok">‚úì Safe to upload</span>
              {% elif file.commons_check_status == "EXACT_MATCH" %}
                <span class="badge dup">Duplicate</span>
              {% elif file.commons_check_status == "POSSIBLE_SCALED_VARIANT" %}
                <span class="badge warn">Variant?</span>
              {% elif file.commons_check_status == "EXISTS_DIFFERENT_CONTENT" %}
                <span class="badge warn">Name conflict</span>
              {% elif file.commons_check_status == "PENDING" %}
                <span class="badge pending">Pending</span>
              {% else %}
                <span class="badge pending">{{ file.commons_check_status }}</span>
              {% endif %}
            </div>
          {% endif %}

          {% if file.commons_check_status == "NOT_ON_COMMONS" %}
            <div class="upload-panel">
              <h4>Upload to Wikimedia Commons</h4>

              {% if not upload_enabled %}
                <div class="hint">üîí Upload disabled. Add <code>COMMONS_USERNAME</code> and <code>COMMONS_PASSWORD</code> to your <code>.env</code>, then restart.</div>
              {% endif %}

              <div class="upload-row">
                <label for="target-{{ loop.index }}">Commons filename</label>
                <input id="target-{{ loop.index }}" type="text"
                       value="{{ file.upload_suggestion.suggested_filename }}"
                       {{ 'disabled' if not upload_enabled else '' }}>
              </div>

              <div class="upload-row">
                <label for="cat-{{ loop.index }}">Category</label>
                <input id="cat-{{ loop.index }}" type="text"
                       value="{{ file.upload_suggestion.category_slug }}"
                       {{ 'disabled' if not upload_enabled else '' }}>
              </div>

              <div class="upload-actions">
                <button
                  type="button"
                  id="btn-{{ loop.index }}"
                  class="btn btn-primary"
                  data-upload
                  data-path="{{ file.path }}"
                  data-target-id="target-{{ loop.index }}"
                  data-cat-id="cat-{{ loop.index }}"
                  data-status-id="st-{{ loop.index }}"
                  {{ 'disabled' if not upload_enabled else '' }}
                >‚¨ÜÔ∏è Upload</button>
                <span id="st-{{ loop.index }}" class="status"></span>
                <span class="hint">You can edit the filename before uploading.</span>
              </div>
              <div class="divider"></div>
              <div class="hint">Opens the file page with initial description and categories.</div>
            </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
      <p>No files detected yet. Drop JPG/JPEG files into the watch folder.</p>
    {% endif %}
  </div>

  <script>
  // Attach one handler to all Upload buttons. Avoid brittle inline onclicks.
  function bindUploadHandlers() {
    const buttons = document.querySelectorAll('button[data-upload]');
    buttons.forEach(btn => {
      btn.addEventListener('click', async (ev) => {
        const statusId = btn.dataset.statusId;
        const st = document.getElementById(statusId);
        const targetInput = document.getElementById(btn.dataset.targetId);
        const catInput = document.getElementById(btn.dataset.catId);
        const localPath = btn.dataset.path; // plain attribute keeps backslashes as-is
        const target = (targetInput?.value || '').trim();
        const category_slug = (catInput?.value || '').trim();

        if (!target) { alert("Please enter a target filename."); return; }

        btn.disabled = true;
        if (st) { st.textContent = "Uploading‚Ä¶"; st.className = "status"; }

        try {
          const resp = await fetch('{{ url_for("api_upload") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: localPath, target, category_slug })
          });
          const ct = resp.headers.get('content-type') || '';
          const data = ct.includes('application/json') ? await resp.json() : { ok:false, error: 'Non-JSON response', status: resp.status };

          if (!resp.ok || !data.ok) {
            if (st) { st.textContent = "Upload failed"; st.className = "status err"; }
            console.error('Upload error', data);
            alert('Upload failed: ' + (data.error ? JSON.stringify(data.error) : resp.statusText));
            btn.disabled = false;
            return;
          }
          if (st) { st.textContent = "Uploaded ‚úì"; st.className = "status ok"; }
          if (data.url) { window.open(data.url, '_blank'); }
          setTimeout(() => location.reload(), 600);
        } catch (e) {
          if (st) { st.textContent = "Upload error"; st.className = "status err"; }
          console.error('Upload exception', e);
          alert('Upload error: ' + e);
          btn.disabled = false;
        }
      }, { passive: true });
    });
  }

  document.addEventListener('DOMContentLoaded', bindUploadHandlers);

  // auto-refresh (so background Commons check results appear)
  let lastSig = null;
  function sig(arr) {
    return (arr||[]).map(f => `${f.path}|${f.commons_check_status}|${f.sha1_local}`).sort().join('::');
  }
  setInterval(async () => {
    try {
      const r = await fetch('/api/files');
      const files = await r.json();
      const s = sig(files);
      if (lastSig === null) { lastSig = s; return; }
      if (s !== lastSig) location.reload();
    } catch {}
  }, 3000);
  </script>
</body>
</html>
