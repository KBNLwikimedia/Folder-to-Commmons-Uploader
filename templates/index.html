<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Folder → Commons Uploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f6f7f9; --panel:#fff; --muted:#6b7280; --ink:#111827; --br:#e5e7eb;
      --pill-safe:#10b981; --pill-dupe:#ef4444; --pill-name:#f59e0b; --pill-check:#6b7280; --pill-err:#ef4444; --pill-scaled:#8b5cf6; --pill-up:#2563eb;
    }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--ink); }
    header { background:#fff; border-bottom:1px solid var(--br); }
    .wrap { max-width:1200px; margin:0 auto; padding:12px 16px; }
    h1 { font-size:20px; margin:0; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px; }
    .ctrl { display:flex; align-items:center; gap:6px; }
    input[type="text"], select {
      border:1px solid var(--br); border-radius:10px; padding:8px 10px; background:#fff;
    }
    .btn { display:inline-flex; align-items:center; gap:6px; border:1px solid var(--br); background:#fff; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer; text-decoration:none; }
    .btn.primary { background:#2563eb; border-color:#2563eb; color:#fff; }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }

    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; margin-top:16px; }
    @media (max-width: 1100px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } }

    .card { background:var(--panel); border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,.06); overflow:hidden; display:flex; flex-direction:column; }
    .thumb { width:100%; height:210px; object-fit:cover; background:#ddd; }
    .body { padding:12px; display:flex; flex-direction:column; gap:8px; }
    .title { font-weight:700; text-decoration:none; color:#1f2937; }
    .muted { color:var(--muted); }
    .row { display:grid; grid-template-columns: 120px 1fr; gap:6px 10px; font-size:14px; }
    .pill { display:inline-flex; align-items:center; gap:6px; font-size:12px; font-weight:700; color:#fff; padding:4px 8px; border-radius:999px; }
    .safe { background:var(--pill-safe); }
    .duplicate { background:var(--pill-dupe); }
    .nameexists { background:var(--pill-name); }
    .scaled { background:var(--pill-scaled); }
    .checking { background:var(--pill-check); }
    .error { background:var(--pill-err); }
    .uploaded { background:var(--pill-up); }

    .footer { display:flex; justify-content:space-between; align-items:center; margin-top:8px; }
    .links { display:flex; gap:6px; }
    .chiplink { color:#2563eb; text-decoration:none; font-weight:600; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <h1>Folder → Commons Uploader</h1>
        <a class="btn" href="{{ url_for('settings_view') }}">Settings</a>
      </div>

      <div class="controls">
        <div class="ctrl">
          <label for="q" class="muted">Search</label>
          <input id="q" type="text" placeholder="filename or suggestion…" oninput="applyFilters()">
        </div>
        <div class="ctrl">
          <label for="status" class="muted">Status</label>
          <select id="status" onchange="applyFilters()">
            <option value="all">All</option>
            <option value="safe">Safe to upload</option>
            <option value="duplicate">Duplicate</option>
            <option value="nameexists">Name exists (diff content)</option>
            <option value="scaled">Scaled variant</option>
            <option value="checking">Checking…</option>
            <option value="error">Error</option>
            <option value="uploaded">Uploaded</option>
          </select>
        </div>
        <div class="ctrl">
          <label class="muted"><input type="checkbox" id="autorefresh" onchange="toggleAutoRefresh(this)"> Auto-refresh</label>
        </div>
        <div class="ctrl">
          <span class="muted">Visible: <span id="visibleCount">0</span> / {{ total_files }}</span>
        </div>
        {% if upload_enabled %}
        <div class="ctrl" id="bulkBox" style="display:none;">
          <button class="btn primary" onclick="bulkUpload()">Bulk upload all visible “Safe to upload”</button>
        </div>
        {% endif %}
      </div>
    </div>
  </header>

  <main class="wrap">
    {% if files|length == 0 %}
      <p class="muted">No files yet. Drop JPEGs in <code>{{ settings.watch_folder }}</code> and keep this page open.</p>
    {% endif %}

    <div id="cards" class="grid">
      {% for f in files %}
      <div class="card file-card"
           data-name="{{ f.name|lower }}"
           data-suggest="{{ f.upload_suggestion.suggested_filename|lower }}"
           data-status="{{ f.status_key }}">
        <img class="thumb" src="{{ f.urls.thumb }}" loading="lazy" alt="">
        <div class="body">
          <a class="title" href="{{ f.urls.detail }}">{{ f.name }}</a>

          <div class="row">
            <div class="muted">Size</div><div>{{ "%.2f"|format(f.size_mb) }} MB</div>
            <div class="muted">Created</div><div>{{ f.created }}</div>
            <div class="muted">Dimensions</div>
            <div>
              {% if f.dimensions.width and f.dimensions.height %}
                {{ f.dimensions.width }} × {{ f.dimensions.height }} px
              {% else %}—{% endif %}
            </div>
            <div class="muted">Commons</div>
            <div>
              {% set key = f.status_key %}
              {% if key == 'safe' %}
                <span class="pill safe">Safe to upload</span>
              {% elif key == 'duplicate' %}
                <span class="pill duplicate">Duplicate</span>
              {% elif key == 'nameexists' %}
                <span class="pill nameexists">Name exists</span>
              {% elif key == 'scaled' %}
                <span class="pill scaled">Scaled variant</span>
              {% elif key == 'uploaded' %}
                <span class="pill uploaded">Uploaded</span>
              {% elif key == 'checking' %}
                <span class="pill checking">Checking on Commons in progress</span>
              {% else %}
                <span class="pill error">Error</span>
              {% endif %}

              {% if f.remote_primary and key in ['duplicate','nameexists','scaled'] %}
                <div class="muted" style="margin-top:4px">
                  Commons file: <a class="chiplink" href="{{ f.remote_primary.url }}" target="_blank">{{ f.remote_primary.title }}</a>
                </div>
              {% endif %}
            </div>

            {% if key == 'duplicate' or key == 'nameexists' or key == 'scaled' %}
              <div class="muted">Local filename</div><div>{{ f.name }}</div>
              <div class="muted">Local subfolder</div><div>{{ f.upload_suggestion.category_slug }}</div>
            {% else %}
              <div class="muted">Suggested filename</div><div>{{ f.upload_suggestion.suggested_filename }}</div>
              <div class="muted">Suggested category</div><div>{{ f.upload_suggestion.category_slug or '—' }}</div>
            {% endif %}
          </div>

          <div class="footer">
            <div class="muted">SHA-1: {{ (f.sha1_local or '')[:10] ~ ('…' if f.sha1_local) }}</div>
            <div class="links">
              <a class="btn" href="{{ f.urls.detail }}">More details</a>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </main>

  <script>
    const statusSel = document.getElementById('status');
    const qInput = document.getElementById('q');
    const cards = Array.from(document.querySelectorAll('.file-card'));
    const visibleCount = document.getElementById('visibleCount');
    const bulkBox = document.getElementById('bulkBox');

    function applyFilters() {
      const q = qInput.value.trim().toLowerCase();
      const st = statusSel.value;

      let shown = 0;
      cards.forEach(c => {
        const name = c.dataset.name || '';
        const suggest = c.dataset.suggest || '';
        const status = c.dataset.status || 'checking';

        const matchText = (!q) || name.includes(q) || suggest.includes(q);
        const matchStatus = (st === 'all') || (status === st);

        const show = matchText && matchStatus;
        c.style.display = show ? '' : 'none';
        if (show) shown++;
      });

      visibleCount.textContent = shown.toString();

      // Show bulk upload only if Status filter == 'safe' (and there is at least one visible)
      if (bulkBox) {
        bulkBox.style.display = (statusSel.value === 'safe' && shown > 0) ? '' : 'none';
      }
    }

    // Auto-refresh (every 8s) toggle with persistence
    const autoChk = document.getElementById('autorefresh');
    const AUTO_KEY = 'ftc_auto_refresh';
    let _autoTimer = null;

    function startAuto() {
      if (_autoTimer) clearInterval(_autoTimer);
      _autoTimer = setInterval(() => { window.location.reload(); }, 8000);
    }
    function stopAuto() {
      if (_autoTimer) { clearInterval(_autoTimer); _autoTimer = null; }
    }
    function toggleAutoRefresh(el) {
      if (el.checked) {
        localStorage.setItem(AUTO_KEY, '1');
        startAuto();
      } else {
        localStorage.removeItem(AUTO_KEY);
        stopAuto();
      }
    }
    // init state
    if (localStorage.getItem(AUTO_KEY) === '1') {
      autoChk.checked = true;
      startAuto();
    }

    async function bulkUpload() {
      if (!confirm('Upload all visible “Safe to upload” items now?')) return;
      try {
        const r = await fetch('{{ url_for("api_bulk_upload") }}', { method:'POST' });
        const j = await r.json();
        if (!r.ok || !j.ok) {
          alert('Bulk upload failed: ' + JSON.stringify(j.error || j));
        } else {
          alert(`Bulk upload done. Uploaded ${j.uploaded}/${j.requested}.`);
          window.location.reload();
        }
      } catch (e) {
        alert('Bulk upload error: ' + e);
      }
    }

    // First layout
    applyFilters();
  </script>
</body>
</html>
